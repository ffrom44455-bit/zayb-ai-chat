<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zayb AI — Universal Chat (Static)</title>
  <meta name="description" content="Universal AI Chat Interface (static single-file) — Zayb AI" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small helpers */
    .scrollbar-thin::-webkit-scrollbar { height: 8px; width: 8px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(100,116,139,.4); border-radius: 8px; }
    /* message bubble max-widths */
    .msg-user { align-self: flex-end; }
    .msg-assistant { align-self: flex-start; }
    [contenteditable]:focus { outline: none; }
    /* simple markdown-like code styling */
    pre { background: rgba(15,23,42,.6); padding: .5rem; border-radius: .5rem; overflow:auto; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

  <div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="w-80 bg-white border-r border-slate-200 flex flex-col">
      <div class="px-4 py-4 flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-indigo-500 rounded-lg flex items-center justify-center text-white font-bold">Z</div>
        <div>
          <h1 class="text-lg font-semibold">Zayb AI</h1>
          <p class="text-xs text-slate-500">Universal AI Chat (static)</p>
        </div>
      </div>

      <div class="px-4 pb-4">
        <button id="newChatBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 rounded">+ New Chat</button>
      </div>

      <div class="px-3 pb-2">
        <div class="flex items-center justify-between text-xs text-slate-500 px-1">
          <span>Chats</span>
          <div class="flex gap-2">
            <button id="settingsBtn" class="p-1 hover:bg-slate-100 rounded" title="Settings">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3" /></svg>
            </button>
            <button id="clearAllBtn" class="p-1 hover:bg-slate-100 rounded" title="Clear all chats">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4a1 1 0 011 1v1H9V4a1 1 0 011-1z" /></svg>
            </button>
          </div>
        </div>
      </div>

      <div id="chatList" class="flex-1 overflow-auto px-2 scrollbar-thin">
        <!-- dynamic chat items -->
      </div>

      <div class="px-4 py-3 border-t border-slate-100 text-xs text-slate-500">
        <div>Model: <span id="footerModelName" class="font-medium">—</span></div>
        <div class="mt-1">Status: <span id="apiStatus" class="font-medium text-amber-600">Not configured</span></div>
      </div>
    </aside>

    <!-- Main chat area -->
    <main class="flex-1 flex flex-col">
      <!-- Header -->
      <header class="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-gradient-to-r from-white to-slate-50">
        <div>
          <div class="text-sm text-slate-500">AI</div>
          <div class="text-xl font-semibold flex items-center gap-3">
            <span>Zayb AI</span>
            <span id="activeChatTitle" class="text-slate-400 text-sm font-normal">(no chat)</span>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button id="renameChatBtn" class="px-3 py-1.5 bg-slate-100 rounded text-sm text-slate-700 hidden">Rename</button>
          <button id="deleteChatBtn" class="px-3 py-1.5 bg-rose-50 text-rose-700 rounded text-sm hidden">Delete</button>
          <button id="openSettingsHeaderBtn" class="px-3 py-1.5 bg-slate-100 rounded text-sm">Settings</button>
        </div>
      </header>

      <!-- Messages -->
      <section class="flex-1 overflow-auto p-6" id="messagesContainer" style="display:flex; flex-direction:column; gap:.75rem;">
        <!-- message bubbles go here -->
        <div id="emptyState" class="mx-auto mt-8 text-center text-slate-400">
          <div class="text-2xl font-semibold">Start a conversation</div>
          <div class="mt-2 text-sm">Click "New Chat" or select a previous chat from the left.</div>
        </div>
      </section>

      <!-- Composer -->
      <footer class="px-6 py-4 border-t border-slate-200 bg-white">
        <div class="max-w-5xl mx-auto flex gap-3">
          <div class="flex-1">
            <div id="inputBox" class="min-h-[56px] max-h-36 overflow-auto bg-slate-50 p-3 rounded-lg border border-slate-100" contenteditable="true" role="textbox" aria-multiline="true" spellcheck="true" placeholder="Ask Zayb AI something..."></div>
            <div class="mt-2 text-xs text-slate-400 flex items-center justify-between">
              <div><span id="charCount">0</span> chars</div>
              <div class="flex gap-2">
                <button id="btnInsertSample" class="px-2 py-1 text-xs bg-slate-100 rounded">Insert sample</button>
              </div>
            </div>
          </div>

          <div class="w-40 flex flex-col justify-between">
            <button id="sendBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded">Send</button>
            <button id="stopBtn" class="w-full mt-2 bg-amber-50 text-amber-700 py-2 rounded hidden">Stop</button>
          </div>
        </div>
      </footer>
    </main>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-2xl bg-white rounded-lg shadow-lg overflow-hidden">
      <div class="px-6 py-4 border-b">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Settings</h2>
          <button id="closeSettings" class="text-slate-500 hover:text-slate-800">Close</button>
        </div>
      </div>
      <div class="px-6 py-4 space-y-4">
        <div>
          <label class="block text-xs text-slate-600 mb-1">API Base URL</label>
          <input id="apiBaseInput" class="w-full border rounded px-3 py-2 text-sm" placeholder="https://api.openrouter.ai/v1" />
          <p class="text-xs text-slate-400 mt-1">The base URL for your provider (e.g. OpenRouter). Keep trailing path out; the client will call <code>/chat/completions</code>.</p>
        </div>

        <div>
          <label class="block text-xs text-slate-600 mb-1">API Key</label>
          <input id="apiKeyInput" class="w-full border rounded px-3 py-2 text-sm" placeholder="sk-..." />
          <div class="mt-2 flex gap-2">
            <button id="saveSettingsBtn" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm">Save</button>
            <button id="clearApiKeyBtn" class="px-3 py-1 bg-rose-50 text-rose-700 rounded text-sm">Clear Key</button>
            <button id="testConnectionBtn" class="px-3 py-1 bg-slate-100 rounded text-sm">Test</button>
            <span id="testResult" class="text-sm text-slate-500"></span>
          </div>
        </div>

        <div>
          <label class="block text-xs text-slate-600 mb-1">Model Name</label>
          <input id="modelInput" class="w-full border rounded px-3 py-2 text-sm" placeholder="e.g., gpt-4o-mini or a custom model" />
        </div>

        <div class="text-xs text-slate-500">
          This static client calls your configured endpoint directly from the browser, using the API key you provide. If your provider requires server-side proxying for security or CORS, you should host a tiny server to forward requests. Keep your key safe.
        </div>
      </div>
    </div>
  </div>

  <!-- Simple confirm modal for deletion -->
  <div id="confirmModal" class="fixed inset-0 z-40 hidden items-center justify-center bg-black/30 p-4">
    <div class="bg-white rounded p-4 w-full max-w-md">
      <div class="text-lg font-semibold">Confirm</div>
      <div class="mt-2 text-sm text-slate-600" id="confirmText">Are you sure?</div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="confirmCancel" class="px-3 py-1 rounded bg-slate-100">Cancel</button>
        <button id="confirmOk" class="px-3 py-1 rounded bg-rose-600 text-white">Yes, delete</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Storage keys ----------
    const STORAGE = {
      CHATS: 'zayb_ai_chats_v1',
      SETTINGS: 'zayb_ai_settings_v1'
    };

    // ---------- Default settings ----------
    const DEFAULT_SETTINGS = {
      apiBase: 'https://api.openrouter.ai/v1',
      apiKey: '',
      model: 'gpt-4o-mini'
    };

    // ---------- App state ----------
    let settings = loadSettings();
    let chats = loadChats();
    let activeChatId = null;
    let isWaitingForResponse = false;
    let currentController = null;

    // ---------- Elements ----------
    const chatListEl = document.getElementById('chatList');
    const newChatBtn = document.getElementById('newChatBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettingsBtn = document.getElementById('closeSettings');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const modelInput = document.getElementById('modelInput');
    const apiBaseInput = document.getElementById('apiBaseInput');
    const footerModelName = document.getElementById('footerModelName');
    const apiStatus = document.getElementById('apiStatus');
    const messagesContainer = document.getElementById('messagesContainer');
    const emptyState = document.getElementById('emptyState');
    const inputBox = document.getElementById('inputBox');
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    const charCount = document.getElementById('charCount');
    const btnInsertSample = document.getElementById('btnInsertSample');
    const activeChatTitle = document.getElementById('activeChatTitle');
    const renameChatBtn = document.getElementById('renameChatBtn');
    const deleteChatBtn = document.getElementById('deleteChatBtn');
    const openSettingsHeaderBtn = document.getElementById('openSettingsHeaderBtn');
    const clearApiKeyBtn = document.getElementById('clearApiKeyBtn');
    const testConnectionBtn = document.getElementById('testConnectionBtn');
    const testResult = document.getElementById('testResult');
    const newChatHeaderBtn = document.getElementById('newChatBtn');
    const settingsHeaderBtn = document.getElementById('settingsBtn');
    const confirmModal = document.getElementById('confirmModal');
    const confirmText = document.getElementById('confirmText');
    const confirmOk = document.getElementById('confirmOk');
    const confirmCancel = document.getElementById('confirmCancel');
    const clearAllChatsBtn = document.getElementById('clearAllBtn');
    const renameBtn = document.getElementById('renameChatBtn');
    const deleteBtn = document.getElementById('deleteChatBtn');

    // ---------- Initialization ----------
    function init() {
      applySettingsToUI();
      renderChatList();
      updateFooterStatus();
      attachEventListeners();

      // select last active chat if exists
      if (chats.length) {
        selectChat(chats[0].id);
      }
    }

    function attachEventListeners() {
      newChatBtn.addEventListener('click', () => newChat());
      newChatHeaderBtn.addEventListener('click', () => newChat());
      settingsBtn.addEventListener('click', () => openSettings());
      openSettingsHeaderBtn.addEventListener('click', () => openSettings());
      closeSettingsBtn.addEventListener('click', () => closeSettings());
      saveSettingsBtn.addEventListener('click', () => saveSettingsFromUI());
      clearApiKeyBtn.addEventListener('click', () => { apiKeyInput.value=''; settings.apiKey=''; saveSettings(); applySettingsToUI(); });
      testConnectionBtn.addEventListener('click', () => testConnection());
      clearAllChatsBtn.addEventListener('click', () => confirmAction('Clear all chats?', () => { chats=[]; saveChats(); renderChatList(); renderMessages(null); }));
      sendBtn.addEventListener('click', () => onSend());
      stopBtn.addEventListener('click', () => onStop());
      btnInsertSample.addEventListener('click', () => {
        inputBox.innerText = "Write a short, aggressive PvP taunt in 2 lines.";
        updateCharCount();
        inputBox.focus();
      });
      inputBox.addEventListener('input', updateCharCount);
      inputBox.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          onSend();
        }
      });
      confirmCancel.addEventListener('click', () => closeConfirm());
      // rename + delete
      renameBtn.addEventListener('click', () => renameActiveChat());
      deleteBtn.addEventListener('click', () => confirmAction('Delete this chat?', () => {
        if (!activeChatId) return;
        chats = chats.filter(c => c.id !== activeChatId);
        saveChats();
        activeChatId = chats.length ? chats[0].id : null;
        renderChatList();
        renderMessages(activeChatId ? getChatById(activeChatId) : null);
      }));
    }

    // ---------- Confirm Modal ----------
    function confirmAction(text, okCb) {
      confirmText.innerText = text;
      confirmModal.classList.remove('hidden');
      confirmOk.onclick = () => { okCb(); closeConfirm(); };
    }
    function closeConfirm() {
      confirmModal.classList.add('hidden');
      confirmOk.onclick = null;
    }

    // ---------- Settings ----------
    function loadSettings() {
      try {
        const raw = localStorage.getItem(STORAGE.SETTINGS);
        if (!raw) return {...DEFAULT_SETTINGS};
        return {...DEFAULT_SETTINGS, ...JSON.parse(raw)};
      } catch (e) {
        console.warn('Failed to load settings', e);
        return {...DEFAULT_SETTINGS};
      }
    }

    function saveSettings() {
      localStorage.setItem(STORAGE.SETTINGS, JSON.stringify(settings));
      applySettingsToUI();
      updateFooterStatus();
    }

    function applySettingsToUI() {
      apiKeyInput.value = settings.apiKey || '';
      modelInput.value = settings.model || DEFAULT_SETTINGS.model;
      apiBaseInput.value = settings.apiBase || DEFAULT_SETTINGS.apiBase;
      footerModelName.innerText = settings.model || '—';
      apiStatus.innerText = settings.apiKey ? 'Configured' : 'Not configured';
      apiStatus.className = settings.apiKey ? 'font-medium text-emerald-600' : 'font-medium text-amber-600';
    }

    function saveSettingsFromUI() {
      settings.apiKey = apiKeyInput.value.trim();
      settings.model = modelInput.value.trim() || DEFAULT_SETTINGS.model;
      settings.apiBase = (apiBaseInput.value.trim() || DEFAULT_SETTINGS.apiBase).replace(/\/+$/, '');
      saveSettings();
      closeSettings();
      renderChatList();
    }

    function openSettings() {
      settingsModal.classList.remove('hidden');
      apiKeyInput.focus();
    }
    function closeSettings() {
      settingsModal.classList.add('hidden');
    }

    async function testConnection() {
      testResult.innerText = 'Testing...';
      try {
        if (!settings.apiKey) {
          testResult.innerText = 'No API key.';
          return;
        }
        const url = settings.apiBase.replace(/\/+$/,'') + '/models';
        // Attempt a GET to /models - if provider supports it and CORS allows, this gives feedback.
        const resp = await fetch(url, {
          method: 'GET',
          headers: { 'Authorization': 'Bearer ' + settings.apiKey }
        });
        if (resp.ok) {
          testResult.innerText = 'OK ✔';
        } else {
          testResult.innerText = 'Response: ' + resp.status + ' ' + resp.statusText;
        }
      } catch (e) {
        testResult.innerText = 'Error (CORS or network)';
        console.warn(e);
      }
      setTimeout(()=>{ testResult.innerText=''; }, 3500);
    }

    // ---------- Chats storage ----------
    function loadChats() {
      try {
        const raw = localStorage.getItem(STORAGE.CHATS);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.warn('Failed to load chats', e);
        return [];
      }
    }

    function saveChats() {
      localStorage.setItem(STORAGE.CHATS, JSON.stringify(chats));
      renderChatList();
    }

    // ---------- Chat utilities ----------
    function generateId(prefix='c') {
      return prefix + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
    }

    function newChat() {
      const chat = {
        id: generateId(),
        title: 'New chat',
        model: settings.model || DEFAULT_SETTINGS.model,
        messages: [],
        createdAt: Date.now(),
        updatedAt: Date.now()
      };
      chats.unshift(chat);
      saveChats();
      selectChat(chat.id);
    }

    function getChatById(id) {
      return chats.find(c => c.id === id) || null;
    }

    function selectChat(id) {
      activeChatId = id;
      // move selected chat to top for convenience
      const idx = chats.findIndex(c => c.id === id);
      if (idx > 0) {
        const [c] = chats.splice(idx,1);
        chats.unshift(c);
        saveChats();
      }
      renderChatList();
      renderMessages(getChatById(id));
    }

    function renameActiveChat() {
      if (!activeChatId) return;
      const chat = getChatById(activeChatId);
      const newTitle = prompt('Rename chat', chat.title || 'Chat');
      if (newTitle !== null) {
        chat.title = newTitle.trim() || chat.title;
        chat.updatedAt = Date.now();
        saveChats();
        renderChatList();
        renderMessages(chat);
      }
    }

    function renderChatList() {
      chatListEl.innerHTML = '';
      if (!chats.length) {
        chatListEl.innerHTML = '<div class="px-3 py-4 text-sm text-slate-400">No chats yet. Start one!</div>';
        return;
      }
      chats.forEach(chat => {
        const lastMsg = chat.messages.length ? chat.messages[chat.messages.length-1] : null;
        const snippet = lastMsg ? (lastMsg.role === 'user' ? 'You: ' : 'Zayb: ') + (lastMsg.content || '').slice(0, 80) : 'Empty';
        const el = document.createElement('button');
        el.className = `w-full text-left rounded p-3 mb-2 hover:bg-slate-50 flex items-start gap-3 ${activeChatId === chat.id ? 'bg-slate-50 border border-slate-100 shadow-sm' : ''}`;
        el.innerHTML = `
          <div class="w-9 h-9 rounded bg-gradient-to-br from-indigo-500 to-purple-600 text-white flex items-center justify-center font-semibold">${chat.title.charAt(0) || 'C'}</div>
          <div class="flex-1">
            <div class="font-medium text-sm">${escapeHtml(chat.title)}</div>
            <div class="text-xs text-slate-400 mt-0.5">${escapeHtml(snippet)}</div>
          </div>
          <div class="text-xs text-slate-400">${new Date(chat.updatedAt).toLocaleString()}</div>
        `;
        el.addEventListener('click', () => selectChat(chat.id));
        chatListEl.appendChild(el);
      });
    }

    // ---------- Messages ----------
    function renderMessages(chat) {
      messagesContainer.innerHTML = '';
      if (!chat) {
        emptyState.classList.remove('hidden');
        activeChatTitle.innerText = '(no chat)';
        renameChatBtn.classList.add('hidden');
        deleteChatBtn.classList.add('hidden');
        return;
      }
      emptyState.classList.add('hidden');
      activeChatTitle.innerText = chat.title || '(untitled)';
      renameChatBtn.classList.remove('hidden');
    
